<html>
  <head>
    <title>kitchen sink</title>
    <script src="js/sheetengine-1.2.0.js"></script>
    <script src="js/pxloader-all.min.js"></script>
    <script type="text/javascript">
      var loader = new PxLoader();
      var purple = loader.addImage('images/texture.png');

      loader.addCompletionListener(function() {
        var canvasElement = document.getElementById('mainCanvas');
        sheetengine.scene.init(canvasElement, {w:2000,h:1500});

        var basesheet = new sheetengine.BaseSheet({x:0,y:0,z:0}, {alphaD:90,betaD:0,gammaD:0}, {w:256,h:256});
        basesheet.color = '#5D7E36';

        var createSheet = function(x, y, z, onclick) {
          var sheet = new sheetengine.Sheet({x:x, y:y, z:z}, {alphaD:90,betaD:0,gammaD:0}, {w: 128,h: 128});
          // sheet.context.fillStyle = '#FFF';
          // sheet.context.fillRect(0,0,40,40);
          sheet.context.drawImage(purple, 0,0);
          sheet.onclick = onclick;

          return sheet;
        };

        var sheets = [];
        sheets.push(createSheet(0, 0, 0, function(event) { console.log('hit1'); }));
        sheets.push(createSheet(128, 0, 64, function(event) { console.log('hit2'); }));

        canvasElement.onclick = function(event) {
          var coordsFromEvent = function(event, z) {
            var puv = {
              u:event.clientX - sheetengine.canvas.offsetLeft + pageXOffset,
              v:event.clientY - sheetengine.canvas.offsetTop + pageYOffset + z
            };
            var pxy = sheetengine.transforms.inverseTransformPoint({
              u:puv.u + sheetengine.scene.center.u,
              v:puv.v + sheetengine.scene.center.v
            });

            return pxy;
          };

          var overlap = function(obj, event) {
            var coords = coordsFromEvent(event, obj.centerp.z);
            if (coords.x > obj.centerp.x - obj.width / 2
               && coords.x < obj.centerp.x + obj.width / 2
               && coords.y > obj.centerp.y - obj.height / 2
               && coords.y < obj.centerp.y + obj.height / 2) {
              return true;
            }
            return false;
          };

          // console.log(sheetengine.drawing.getPointuv(sheet1.centerp));

          var checkOverlapSheets = function(sheets) {
            sheets = sheets.sort(function(a, b) {
              return  a.centerp.z < b.centerp.z;
            });

            var hit = false;

            sheets.forEach(function(sheet) {
              if (!hit && overlap(sheet, event)) {
                sheet.onclick(event);
                hit = true;
              }
            });
          };

          checkOverlapSheets(sheets);
        }

        sheetengine.calc.calculateAllSheets();

        sheetengine.drawing.drawScene(true);
      });

      loader.start();
    </script>
  </head>
  <body>
    <canvas id="mainCanvas" width="500" height="300"></canvas>
  </body>
</html>
